<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>진행 중인 회의 - Ocean</title>
    <link rel="stylesheet" th:href="@{/css/meeting-list.css}">
</head>
<body>
<div class="meeting-list-container">
    <div class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 20px;">
                <h1>진행 중인 회의</h1>
                <button class="btn-refresh" onclick="location.reload()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 4v6h6M23 20v-6h-6"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                </button>
            </div>
            <button class="btn-back" onclick="goBackToWorkspace()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
                워크스페이스로 돌아가기
            </button>
        </div>
    </div>

    <!-- 타임리프로 회의 목록 렌더링 -->
    <div id="meetingGrid" class="meeting-grid" th:if="${activeMeetings != null and !activeMeetings.isEmpty()}">
        <div th:each="meeting : ${activeMeetings}"
             class="meeting-card"
             th:classappend="${meeting.hostId == currentUserId} ? 'your-meeting' : ''">

            <div class="meeting-status status-active">
                <span class="status-dot"></span>
                진행 중
            </div>

            <h3 class="meeting-title">
                <span th:text="${meeting.title} ?: '제목 없는 회의'"></span>
                <span th:if="${meeting.hostId == currentUserId}" class="host-badge">호스트</span>
            </h3>

            <div class="meeting-info">
                시작 시간: <span th:text="${meeting.startTime != null ? #temporals.format(meeting.startTime, 'HH:mm') : '시간 정보 없음'}"></span>
            </div>

            <div class="meeting-participants">
                <div class="participant-avatars">
                    <!-- 참가자 아바타 표시 -->
                    <div th:each="participant, iterStat : ${meeting.participants}"
                         th:if="${iterStat.index < 3}"
                         class="participant-avatar"
                         th:title="${participant.displayName}">
                        <span th:text="${#strings.substring(participant.displayName, 0, 1)}"></span>
                    </div>
                    <div th:if="${#lists.size(meeting.participants) > 3}"
                         class="participant-avatar more">
                        +<span th:text="${#lists.size(meeting.participants) - 3}"></span>
                    </div>
                </div>
                <span><span th:text="${meeting.participantCount}"></span>명 참여 중</span>
            </div>

            <div class="meeting-actions">
                <!-- 참가하기/돌아가기 버튼 -->
                <th:block th:with="isParticipant=${#lists.contains(meeting.participants.![userId], currentUserId)}">
                    <a th:if="${isParticipant}"
                       th:href="@{/ocean-video-chat-complete.html(roomId=${meeting.roomId}, workspaceCd=${workspaceCd}, meetingTitle=${meeting.title}, rejoin=true)}"
                       class="btn btn-primary">회의로 돌아가기</a>

                    <a th:unless="${isParticipant}"
                       th:href="@{/ocean-video-chat-complete.html(roomId=${meeting.roomId}, workspaceCd=${workspaceCd}, meetingTitle=${meeting.title})}"
                       class="btn btn-primary">참가하기</a>
                </th:block>

                <button th:if="${meeting.hostId == currentUserId}"
                        class="btn btn-danger"
                        th:onclick="|endMeeting('${meeting.roomId}')|">
                    회의 종료
                </button>
            </div>
        </div>
    </div>

    <!-- 빈 상태 -->
    <div id="emptyState" class="empty-state"
         th:if="${activeMeetings == null or activeMeetings.isEmpty()}"
         style="display: flex;">
        <h2>진행 중인 회의가 없습니다</h2>
        <p>새로운 회의를 시작하거나 초대를 기다려주세요</p>
        <a th:href="@{/meeting/setup(workspaceCd=${workspaceCd})}"
           class="btn btn-primary" style="display: inline-block; width: auto;">
            새 회의 시작하기
        </a>
    </div>
</div>

<!-- Socket.IO는 실시간 업데이트용으로만 사용 -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- 타임리프 변수를 JavaScript로 전달 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const workspaceCd = /*[[${workspaceCd}]]*/ '';
    const currentUserId = /*[[${currentUserId}]]*/ '';
    /*]]>*/
</script>

<script>
    // Socket.IO는 실시간 업데이트용으로만 사용
    let socket;

    document.addEventListener('DOMContentLoaded', function() {
        // 디버깅
        console.log('워크스페이스 코드:', workspaceCd);
        console.log('현재 사용자 ID:', currentUserId);

        connectToMediaServer();
    });

    function connectToMediaServer() {
        const serverUrl = window.location.hostname === 'localhost'
            ? 'https://localhost:3001'
            : 'https://192.168.100.16:3001';

        socket = io(serverUrl, {
            transports: ['websocket'],
            reconnection: true
        });

        socket.on('connect', () => {
            console.log('미디어 서버 연결됨');
            if (workspaceCd) {
                socket.emit('subscribe-workspace', { workspaceId: workspaceCd });
            }
        });

        // 실시간 업데이트 이벤트
        socket.on('room-created', (data) => {
            console.log('새 회의 생성됨:', data);
            if (data.workspaceId === workspaceCd) {
                // 3초 후 새로고침 (사용자가 작업 중일 수 있으므로)
                setTimeout(() => location.reload(), 3000);
            }
        });

        socket.on('room-ended', (data) => {
            console.log('회의 종료됨:', data);
            if (data.workspaceId === workspaceCd) {
                location.reload();
            }
        });

        socket.on('participant-update', (data) => {
            console.log('참가자 업데이트:', data);
            if (data.workspaceId === workspaceCd) {
                // 부분 업데이트 또는 새로고침
                location.reload();
            }
        });
    }

    function goBackToWorkspace() {
        window.location.href = '/wsmain?workspaceCd=' + workspaceCd;
    }

    function endMeeting(roomId) {
        if (confirm('정말로 회의를 종료하시겠습니까? 모든 참가자가 회의에서 나가게 됩니다.')) {
            // Socket.IO로 회의 종료 요청
            socket.emit('end-meeting', { roomId }, (response) => {
                if (response.error) {
                    alert('회의 종료 실패: ' + response.error);
                } else {
                    alert('회의가 종료되었습니다.');
                    location.reload();
                }
            });
        }
    }

    // 페이지 가시성 변경 시 자동 새로고침 (옵션)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            // 페이지가 다시 보이면 새로고침
            location.reload();
        }
    });
</script>
</body>
</html>